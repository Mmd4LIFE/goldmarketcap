version: "3.11"

services:
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: gold_price
      POSTGRES_USER: gold_user
      POSTGRES_PASSWORD: gold_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT_MAPPING:-5435}:5432"

  backend:
    build:
      context: ./backend
    image: gold-price-backend
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://gold_user:gold_password@postgres:5432/gold_price}
    depends_on:
      - postgres
    ports:
      - "8005:8000"

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8005/api/v1}
        NEXT_PUBLIC_API_TOKEN: ${NEXT_PUBLIC_API_TOKEN:-change-me-api-token}
    image: gold-price-frontend
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      # Runtime env vars (non-NEXT_PUBLIC_ prefixed so they're read at runtime)
      API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8005/api/v1}
      API_TOKEN: ${NEXT_PUBLIC_API_TOKEN:-change-me-api-token}
      # Keep NEXT_PUBLIC_ vars for backward compatibility
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8005/api/v1}
      NEXT_PUBLIC_API_TOKEN: ${NEXT_PUBLIC_API_TOKEN:-change-me-api-token}
    depends_on:
      - backend
    ports:
      - "3005:3000"

volumes:
  postgres_data:

